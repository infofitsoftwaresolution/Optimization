name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies (minimal for CI)
      run: |
        python -m pip install --upgrade pip
        # Use minimal requirements in CI to speed up workflow
        if [ -f "requirements-minimal.txt" ]; then
          pip install -r requirements-minimal.txt
        else
          pip install -r requirements.txt
        fi
    
    - name: Create nginx config with IP from secrets
      run: |
        # Read the nginx template and replace server_name with IP from secrets
        if [ -f "nginx-optimization-app.conf" ]; then
          sed "s/server_name _;/server_name ${{ secrets.EC2_HOST }};/" nginx-optimization-app.conf > nginx-optimization-app-deployed.conf
          echo "‚úÖ Created nginx config with IP: ${{ secrets.EC2_HOST }}"
        else
          echo "‚ö†Ô∏è  nginx-optimization-app.conf not found, skipping nginx config creation"
        fi
    
    - name: Prepare deployment archive
      run: |
        # Create file list excluding unwanted files/directories
        find . -type f \
          ! -path './.git/*' \
          ! -path './.github/*' \
          ! -path '*/__pycache__/*' \
          ! -name '*.pyc' \
          ! -path './.venv/*' \
          ! -path './node_modules/*' \
          ! -name '.env.example' \
          ! -name '.env' \
          ! -name 'deployment.tar.gz' \
          > /tmp/files_to_archive.txt
        
        # Add the nginx config file if it exists
        if [ -f "nginx-optimization-app-deployed.conf" ]; then
          echo "nginx-optimization-app-deployed.conf" >> /tmp/files_to_archive.txt
        fi
        
        # Create tar archive from file list
        tar -czf deployment.tar.gz -T /tmp/files_to_archive.txt
    
    - name: Create .env file from secrets
      run: |
        cat > .env << EOF
        # AWS Configuration
        AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION=${{ secrets.AWS_REGION }}
        
        # Database Configuration
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        
        # OpenAI API Key (Optional)
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        
        # Streamlit Configuration
        STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
        EOF

    - name: Test SSH connection
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "Testing SSH connection..."
          hostname
          echo "‚úÖ Connection successful"

    - name: Deploy code to EC2 via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        command_timeout: 30s
        script: |
          mkdir -p /home/ec2-user/Optimization
          cd /home/ec2-user/Optimization
          # Backup .env if it exists (will be overwritten by new .env)
          if [ -f ".env" ]; then
            cp .env /tmp/optimization_env_backup
          fi
          # Remove old files (we'll create fresh .venv after extraction)
          find . -mindepth 1 -maxdepth 1 -exec rm -rf {} +

    - name: Copy deployment archive to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "deployment.tar.gz"
        target: "/home/ec2-user/Optimization/"
        strip_components: 0

    - name: Extract code and restore backups on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        command_timeout: 60s
        script: |
          cd /home/ec2-user/Optimization
          tar -xzf deployment.tar.gz
          rm deployment.tar.gz
          # Don't restore .venv - we'll create a fresh one to avoid conflicts
          # .env will be deployed in the next step

    - name: Deploy .env file to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: ".env"
        target: "/home/ec2-user/Optimization/"
        strip_components: 0

    - name: Clear virtual environment and prepare for fresh install
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        command_timeout: 30s
        script: |
          cd /home/ec2-user/Optimization || exit 1
          echo "üßπ Clearing virtual environment for fresh install..."
          # Remove old virtual environment to avoid conflicts
          if [ -d ".venv" ]; then
            rm -rf .venv
            echo "‚úÖ Removed old virtual environment"
          fi
          # Clear pip cache to free up space
          pip3 cache purge 2>/dev/null || true
          echo "‚úÖ Cleared pip cache"

    - name: Verify deployment and setup environment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        command_timeout: 30s
        script: |
          cd /home/ec2-user/Optimization || exit 1
          echo "üîç Verifying deployed files..."
          if [ ! -f "requirements-minimal.txt" ] && [ ! -f "requirements.txt" ]; then
            echo "‚ùå ERROR: No requirements file found!"
            exit 1
          fi
          if [ ! -d "src" ]; then
            echo "‚ùå ERROR: src directory not found!"
            exit 1
          fi
          echo "‚úÖ Files verified"

    - name: Setup virtual environment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        command_timeout: 60s
        script: |
          cd /home/ec2-user/Optimization || exit 1
          echo "üêç Setting up virtual environment..."
          # Remove old venv
          rm -rf .venv
          # Create fresh venv
          python3 -m venv .venv || python3.10 -m venv .venv || python3.9 -m venv .venv || exit 1
          echo "‚úÖ Virtual environment created"

    - name: Install dependencies
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        command_timeout: 5m
        debug: true
        script: |
          set -e
          cd /home/ec2-user/Optimization
          
          # Check if venv exists and has core packages
          if [ -d ".venv" ] && [ -f ".venv/bin/activate" ]; then
            source .venv/bin/activate
            if python3 -c "import streamlit, pandas, boto3" 2>/dev/null; then
              echo "‚úÖ Core packages already installed, skipping installation"
              exit 0
            fi
          fi
          
          # Activate venv
          source .venv/bin/activate
          
          echo "üì¶ Installing dependencies..."
          
          # Upgrade pip (quick, with timeout)
          timeout 30 pip install --upgrade pip --no-cache-dir 2>&1 | head -5 || true
          
          # Determine requirements file
          REQ_FILE="requirements-minimal.txt"
          [ ! -f "$REQ_FILE" ] && REQ_FILE="requirements.txt"
          
          echo "Using $REQ_FILE"
          echo "Installing packages (timeout: 4 minutes)..."
          
          # Install with explicit timeout and error handling
          timeout 240 pip install --no-cache-dir --disable-pip-version-check -r "$REQ_FILE" 2>&1 | tee /tmp/pip_install.log || {
            echo "‚ö†Ô∏è  Installation had issues"
            echo "Checking if core packages are installed..."
            if python3 -c "import streamlit, pandas, boto3" 2>/dev/null; then
              echo "‚úÖ Core packages are available, continuing..."
            else
              echo "‚ùå Core packages missing, showing pip log:"
              tail -20 /tmp/pip_install.log
              exit 1
            fi
          }
          
          echo "‚úÖ Dependencies installed"

    - name: Validate and restart service
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        command_timeout: 60s
        script: |
          cd /home/ec2-user/Optimization || exit 1
          source .venv/bin/activate || exit 1
          
          # Validate syntax
          echo "üîç Validating Python syntax..."
          python3 -m py_compile src/dashboard.py || exit 1
          echo "‚úÖ Syntax valid"
          
          # Update service file
          if [ -f "streamlit-optimization.service" ]; then
            sudo cp streamlit-optimization.service /etc/systemd/system/
            sudo systemctl daemon-reload
          fi
          
          # Make scripts executable
          chmod +x scripts/start-streamlit-with-secrets.sh 2>/dev/null || true
          
          # Restart service
          sudo systemctl stop streamlit-optimization.service 2>/dev/null || true
          sleep 2
          sudo systemctl start streamlit-optimization.service
          sleep 3
          
          # Check status
          if sudo systemctl is-active --quiet streamlit-optimization.service; then
            echo "‚úÖ Service started successfully"
          else
            echo "‚ùå Service failed to start"
            sudo systemctl status streamlit-optimization.service --no-pager -l | head -10
            exit 1
          fi
          
          # Install and configure Nginx
          echo "üåê Installing and configuring Nginx..."
          
          # Check if nginx is installed
          if ! command -v nginx &> /dev/null; then
            echo "üì¶ Installing Nginx..."
            if command -v yum &> /dev/null; then
              sudo yum install -y nginx || {
                echo "‚ùå Failed to install nginx with yum"
                exit 1
              }
            elif command -v apt-get &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y nginx || {
                echo "‚ùå Failed to install nginx with apt-get"
                exit 1
              }
            else
              echo "‚ùå Cannot determine package manager for nginx installation"
              exit 1
            fi
            echo "‚úÖ Nginx installed"
          else
            echo "‚úÖ Nginx already installed"
          fi
          
          # Ensure nginx directories exist
          sudo mkdir -p /etc/nginx/conf.d
          sudo mkdir -p /var/log/nginx
          
          # Use the pre-configured nginx file with IP from secrets, or fallback to template
          if [ -f "nginx-optimization-app-deployed.conf" ]; then
            sudo cp nginx-optimization-app-deployed.conf /etc/nginx/conf.d/optimization-app.conf
            EC2_IP=$(grep "server_name" /etc/nginx/conf.d/optimization-app.conf | sed 's/.*server_name \([^;]*\);.*/\1/')
            echo "Using pre-configured nginx with IP: $EC2_IP"
          elif [ -f "nginx-optimization-app.conf" ]; then
            # Fallback: try to get IP from EC2 instance
            EC2_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || hostname -I | awk '{print $1}' || echo "_")
            sudo cp nginx-optimization-app.conf /etc/nginx/conf.d/optimization-app.conf
            sudo sed -i "s/server_name _;/server_name $EC2_IP;/" /etc/nginx/conf.d/optimization-app.conf || \
            sudo sed -i "s/server_name.*;/server_name $EC2_IP;/" /etc/nginx/conf.d/optimization-app.conf || true
            echo "Using auto-detected IP: $EC2_IP"
          else
            echo "‚ö†Ô∏è  nginx config file not found"
            exit 1
          fi
          
          # Test and restart nginx
          sudo nginx -t && {
            sudo systemctl restart nginx || sudo systemctl start nginx
            sudo systemctl enable nginx
            echo "‚úÖ Nginx configured and restarted"
          } || {
            echo "‚ùå Nginx configuration test failed"
            sudo nginx -t
            exit 1
          }
          
          # Verify nginx is running
          if sudo systemctl is-active --quiet nginx; then
            echo "‚úÖ Nginx is running"
          else
            echo "‚ö†Ô∏è  Nginx is not running, attempting to start..."
            sudo systemctl start nginx
            sleep 2
            if sudo systemctl is-active --quiet nginx; then
              echo "‚úÖ Nginx started successfully"
            else
              echo "‚ùå Failed to start nginx"
              sudo systemctl status nginx --no-pager -l | head -10
              exit 1
            fi
          fi
          
          # Check if services are running
          echo "üìä Service Status:"
          echo "Streamlit: $(sudo systemctl is-active streamlit-optimization.service)"
          echo "Nginx: $(sudo systemctl is-active nginx)"
          echo ""
          echo "üîç Checking ports:"
          sudo netstat -tuln | grep -E "(8501|80)" || ss -tuln | grep -E "(8501|80)"
          echo ""
          echo "üåê Application URLs:"
          EC2_IP=$(grep "server_name" /etc/nginx/conf.d/optimization-app.conf 2>/dev/null | sed 's/.*server_name \([^;]*\);.*/\1/' || echo "IP_NOT_FOUND")
          PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "UNKNOWN")
          echo "   Nginx config IP: $EC2_IP"
          echo "   Public IP: $PUBLIC_IP"
          echo "   Access at: http://${EC2_IP}/ or http://${PUBLIC_IP}/"
          echo ""
          echo "‚ö†Ô∏è  If connection fails, check:"
          echo "   1. EC2 Security Group allows inbound traffic on port 80 (HTTP)"
          echo "   2. Nginx is running: sudo systemctl status nginx"
          echo "   3. Streamlit is running: sudo systemctl status streamlit-optimization.service"
          
          # Test database connection
          echo ""
          echo "üîç Testing database connection..."
          if [ -f ".env" ]; then
            set -a
            source .env
            set +a
            if [ -n "$DB_HOST" ] && [ -n "$DB_USER" ] && [ -n "$DB_PASSWORD" ]; then
              echo "Database host: $DB_HOST"
              echo "Database user: $DB_USER"
              echo "Database name: ${DB_NAME:-postgres}"
              echo "Database port: ${DB_PORT:-5432}"
              
              # Install PostgreSQL client if not available
              if ! command -v psql &> /dev/null; then
                echo "üì¶ Installing PostgreSQL client..."
                if command -v yum &> /dev/null; then
                  sudo yum install -y postgresql15 || sudo yum install -y postgresql || echo "‚ö†Ô∏è  Could not install psql"
                elif command -v apt-get &> /dev/null; then
                  sudo apt-get update && sudo apt-get install -y postgresql-client || echo "‚ö†Ô∏è  Could not install psql"
                fi
              fi
              
              # Test PostgreSQL connection
              if command -v psql &> /dev/null; then
                export PGPASSWORD="$DB_PASSWORD"
                EC2_IP=$(hostname -I | awk '{print $1}' || echo "unknown")
                echo "Testing connection from EC2 IP: $EC2_IP"
                
                if psql -h "$DB_HOST" -p "${DB_PORT:-5432}" -U "$DB_USER" -d "${DB_NAME:-postgres}" -c "SELECT 1;" &>/dev/null 2>&1; then
                  echo "‚úÖ Database connection successful"
                else
                  echo "‚ùå Database connection test failed"
                  echo ""
                  echo "Common issues and solutions:"
                  echo "1. RDS Security Group Configuration:"
                  echo "   - Go to RDS Console ‚Üí Your Database ‚Üí Connectivity & security"
                  echo "   - Edit the VPC security group"
                  echo "   - Add inbound rule: PostgreSQL (port 5432) from EC2 security group or IP: $EC2_IP"
                  echo ""
                  echo "2. Database Credentials:"
                  echo "   - Verify DB_USER, DB_PASSWORD, DB_NAME in GitHub secrets"
                  echo "   - Check if username is case-sensitive (PostgreSQL usernames are case-sensitive)"
                  echo "   - Current user: $DB_USER"
                  echo ""
                  echo "3. Database User Permissions:"
                  echo "   - Ensure user '$DB_USER' has CONNECT privilege on database '${DB_NAME:-postgres}'"
                  echo ""
                  echo "Attempting connection test with verbose output..."
                  psql -h "$DB_HOST" -p "${DB_PORT:-5432}" -U "$DB_USER" -d "${DB_NAME:-postgres}" -c "SELECT 1;" 2>&1 | head -5 || true
                fi
                unset PGPASSWORD
              else
                echo "‚ö†Ô∏è  psql not available, skipping database connection test"
                echo "   Install PostgreSQL client to test database connectivity"
              fi
            else
              echo "‚ö†Ô∏è  Database credentials incomplete in .env file"
              echo "   Required: DB_HOST, DB_USER, DB_PASSWORD"
            fi
          else
            echo "‚ö†Ô∏è  .env file not found, cannot test database connection"
          fi

